@using Microsoft.AspNetCore.Identity
@model IEnumerable<PriveChat>

@inject UserManager<IdentityUser> UserManager
@{
	var lijst = Model;
	Layout = "";
}

<!DOCTYPE html>
<html>

<head>
	<title></title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<style type="text/css">
		.chat-messages {
			display: flex;
			flex-direction: column;
			max-height: 800px;
			overflow-y: scroll
		}

		.chat-message-left,
		.chat-message-right {
			display: flex;
			flex-shrink: 0
		}

		.chat-message-left {
			margin-right: auto;
		}

		.chat-message-right {
			flex-direction: row-reverse;
			margin-left: auto
		}

		.chatbox {
			height: 70vh;
			overflow: scroll;
		}
	</style>
</head>

<body>
	<partial name="_NavPartial"></partial>
	<div class="container-sm" style="position: relative; top: 5rem;">
		<article class="d-flex justify-content-between">
			<section class="btn btn-outline-secondary flex-fill d-flex justify-content-center">Prive chat</section>
			&nbsp;
			<a class="btn btn-secondary flex-fill d-flex justify-content-center" asp-area="" asp-controller="Group"
				asp-action="Index">zelfhulp groepen</a>
		</article>
		<article class="chat-messages p-4">
			<p class="d-flex justify-content-center">Prive chat</p>
			<section class="chatBox">
				@foreach (var item in Model)
				{
					@if (item.Ontvanger == UserManager.GetUserId(User))
					{
						<div class="chat-message-left pb-4">
							<div class="m-2"><i class="fa fa-user"></i></div>
							<p class="m-2">
								@item.Body
							</p>
						</div>
					}
					else if (item.Afzender == @UserManager.GetUserId(User))
					{
						<div class="chat-message-right pb-4">
							@item.Body
						</div>
					}
				}
			</section>
			<section class="d-flex justify-content-between fixed-bottom m-5">
				<input class="form-control m-1 chatInput" type="text" name="">
				<button class="btn btn-success m-1" onclick="createChat()">verstuur</button>
			</section>
		</article>
	</div>

	<script>
		var list = [];
		var setup = false;
		var ontvang = "f61864df-f3b9-4de5-a8e4-5aa372423dd0";
			if("@UserManager.GetUserId(User)" == "f61864df-f3b9-4de5-a8e4-5aa372423dd0"){
				ontvang = "f455ac26-e1d6-4449-bb5c-fa88c913b520";
			}
		function createChat() {
			var currentdate = new Date();
			var datetime = "Last Sync: " + currentdate.getDay() + "/" + currentdate.getMonth()
				+ "/" + currentdate.getFullYear() + " "
				+ currentdate.getHours() + ":"
				+ currentdate.getMinutes() + ":" + currentdate.getSeconds();
			var input = document.querySelector(".chatInput").value;
			fetch("api/api/", {
				method: "POST",
				body: JSON.stringify({ "DateTime": datetime, "Ontvanger": ontvang, "Afzender": "@UserManager.GetUserId(User)", "Body": input }),
				headers: { "content-type": "application/json" }
			}).then(r => {
				if (r.status != 201) {
					throw "Status: " + r.status;
				} else {
					return r.json();
				}
			}).then(j => {
				var headDiv = document.createElement("div");
				headDiv.classList.add("chat-message-right");
				headDiv.classList.add("pb-4");
				headDiv.innerHTML = j.body;

				document.querySelector(".chatBox").appendChild(headDiv);
				document.querySelector(".chatInput").value = "";
				list.push(j);
			}).catch(r => alert("Er is een fout op getreden " + r));
		}

		setInterval(function () {
			fetch("api/api/", {
				method: "GET"
			}).then(r => {
				if (r.status != 200) {
					throw "Status: " + r.status;
				} else {
					return r.json();
				}
			}).then(j => {
				if (setup != true) {
					list = j;
					setup = true;
				} else {
					if (JSON.stringify(list) != JSON.stringify(j)) {
						list = j;
						j = j[j.length - 1]
						if (j.Ontvanger == "@UserManager.GetUserId(User)") {
							var headDiv = document.createElement("div");
							headDiv.classList.add("chat-message-left");
							headDiv.classList.add("pb-4");
							var element = document.createElement("div");
							element.classList.add("m-2");
							element.innerHTML = '<i class="fa fa-user"></i>';
							var paragraph = document.createElement("p");
							paragraph.classList.add('m-2');
							paragraph.innerHTML = j.body;
							headDiv.appendChild(element);
							headDiv.appendChild(paragraph);

							document.querySelector(".chatBox").appendChild(headDiv);
						}
					}
				}
			}).catch(r => alert("Er is een fout op getreden " + r));
		}, 1000);

	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
